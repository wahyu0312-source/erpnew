<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>東京精密発條株式会社システム</title>
  <link rel="icon" href="./assets/tsh.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer">
  <link rel="stylesheet" href="./style.css">

  <!-- Libs -->
  <script defer src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script defer src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- App -->
  <script defer src="./app.js"></script>
</head>
<body>
  <nav class="nav">
    <div class="nav-left">
      <img src="./assets/tsh.png" class="logo" alt="">
      <span class="brand">東京精密発條株式会社システム</span>
    </div>
    <div class="nav-right">
      <div id="weatherWrap" class="row muted s hidden">
        <i class="fa-solid fa-cloud-sun"></i>
        <span id="wxTemp">--</span>
        <span style="margin:0 .35rem">/</span>
        <span id="wxWind">--</span>
        <span id="wxPlace" class="muted"></span>
      </div>

      <button id="btnToDash"    class="btn ghost hidden"><i class="fa-solid fa-gauge"></i> ダッシュボード</button>
      <button id="btnToSales"   class="btn ghost hidden"><i class="fa-regular fa-handshake"></i> 受注</button>
      <button id="btnToPlan"    class="btn ghost hidden"><i class="fa-solid fa-list-check"></i> 生産計画</button>
      <button id="btnToShip"    class="btn ghost hidden"><i class="fa-solid fa-truck"></i> 出荷予定</button>
      <button id="btnToInvPage" class="btn ghost hidden"><i class="fa-solid fa-boxes-stacked"></i> 在庫</button>
      <button id="btnToFinPage" class="btn hidden"><i class="fa-regular fa-box-archive"></i> 完成品一覧</button>
      <button id="btnToInvoice" class="btn ghost hidden"><i class="fa-regular fa-file-lines"></i> 請求書</button>
      <button id="btnToCharts" class="btn ghost hidden"><i class="fa-solid fa-chart-line"></i> 分析チャート</button>

      <!-- Settings dropdown -->
      <details class="dropdown-inline hidden" id="ddSetting">
        <summary class="btn ghost">
          <i class="fa-solid fa-gear"></i> 設定 <i class="fa-solid fa-caret-down caret" style="margin-left:.25rem"></i>
        </summary>
        <div class="menu right">
          <!-- id harus sama dengan app.js -->
          <button id="btnStationQR" class="menu-item"
                  onclick="this.closest('details')?.removeAttribute('open')">
            <i class="fa-solid fa-qrcode"></i> 工程QR
          </button>
          <hr style="border:none;border-top:1px solid var(--border);margin:.35rem 0">
          <button id="btnLogout" class="menu-item"
                  onclick="this.closest('details')?.removeAttribute('open')">
            <i class="fa-solid fa-right-from-bracket"></i> ログアウト
          </button>
        </div>
      </details>

      <span id="userInfo" class="muted"></span>
    </div>
  </nav>

  <!-- AUTH -->
  <main id="authView" class="container">
    <section class="card card-tight">
      <h2><i class="fa-solid fa-right-to-bracket"></i> ログイン</h2>
      <div class="grid grid-auth">
        <input id="inUser" class="input-lg" placeholder="ユーザー名">
        <input id="inPass" class="input-lg" type="password" placeholder="パスワード">
      </div>
      <button id="btnLogin" class="btn primary full" style="margin-top:.8rem">ログイン</button>
      <p class="muted s" style="margin:.6rem 0 0">※ 上部メニューはログイン後に表示されます。</p>
    </section>
  </main>

  <!-- DASHBOARD -->
  <main id="pageDash" class="container hidden">
    <section class="card" id="ordersSection">
      <header class="row-between">
        <h3><i class="fa-solid fa-clipboard-list"></i> 生産一覧</h3>
        <div class="row gap">
          <input id="searchQ" placeholder="検索..." class="input">
          <button class="btn ghost" id="btnExportOrders"><i class="fa-solid fa-file-csv"></i> 注文CSV</button>
          <button class="btn ghost" onclick="window.print()"><i class="fa-solid fa-print"></i> 印刷</button>
        </div>
      </header>
      <div class="table-wrap" style="max-height:52vh">
        <table class="table s">
          <thead>
            <tr>
              <th>注番 / 得意先</th><th>品名</th><th>品番</th><th>図番</th><th>状態</th><th>工程</th><th>更新日時</th><th>更新者</th><th>操作</th>
            </tr>
          </thead>
          <tbody id="tbOrders"></tbody>
        </table>
      </div>

      <!-- 下: 本日出荷 + 出荷予定 -->
      <div class="grid grid-ship-panels" style="margin-top:1rem">
        <section class="card sub">
          <header class="row-between">
            <h4>本日出荷</h4>
            <span class="muted s">出荷予定シートから</span>
          </header>
          <div id="shipToday" class="ship-list"></div>
        </section>
        <section class="card sub">
          <header class="row-between">
            <h4>出荷予定</h4>
            <div class="muted s">今後の出荷</div>
          </header>
          <div id="shipPlan" class="ship-list"></div>
        </section>
      </div>
    </section>

    <!-- ====== Analytics Charts (分析チャート) ====== -->
    <section id="pageCharts" class="hidden">
      <div class="row-between" style="margin:12px 0 8px">
        <div class="row gap">
          <div class="muted s">ビュー</div>
          <div class="row gap">
            <button id="chTabCust"  class="btn ghost">顧客別合計</button>
            <button id="chTabMonth" class="btn ghost">月別トレンド</button>
            <button id="chTabYear"  class="btn ghost">年別合計</button>
            <button id="chTabKpi"   class="btn ghost">総出荷KPI</button>
            <button id="chTabDash"  class="btn ghost">追加アナリティクス</button>
          </div>
        </div>
        <div class="row gap">
          <label>年
            <select id="chYear" style="min-width:92px"></select>
          </label>
          <label>月
            <select id="chMonth" style="min-width:88px">
              <option value="">(すべて)</option>
              <option value="1">1月</option><option value="2">2月</option><option value="3">3月</option>
              <option value="4">4月</option><option value="5">5月</option><option value="6">6月</option>
              <option value="7">7月</option><option value="8">8月</option><option value="9">9月</option>
              <option value="10">10月</option><option value="11">11月</option><option value="12">12月</option>
            </select>
          </label>
          <label>得意先
            <select id="chCust" style="min-width:220px"><option value="">(すべて)</option></select>
          </label>
          <button id="chRefresh" class="btn">更新</button>
          <button id="chExpPNG" class="btn ghost">PNG出力</button>
          <button id="chExpXLSX" class="btn ghost">Excel出力</button>
        </div>
      </div>

      <div id="chViewCust"  class="card"><canvas id="cvCust"  height="110"></canvas></div>
      <div id="chViewMonth" class="card hidden"><canvas id="cvMonth" height="110"></canvas></div>
      <div id="chViewYear"  class="card hidden"><canvas id="cvYear"  height="110"></canvas></div>
      <div id="chViewKpi"   class="card hidden" style="padding:16px">
        <div class="row wrap gap" style="margin-bottom:8px">
          <div class="kpi" id="kpiTotal"   style="min-width:180px"></div>
          <div class="kpi" id="kpiOrders"  style="min-width:180px"></div>
          <div class="kpi" id="kpiAvg"     style="min-width:180px"></div>
        </div>
        <canvas id="cvKpi" height="90"></canvas>
      </div>
      <div id="chViewDash"  class="grid hidden" style="grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:12px">
        <div class="card"><div class="muted s" style="padding:8px">上位顧客（数量）</div><canvas id="cvTopCust" height="110"></canvas></div>
        <div class="card"><div class="muted s" style="padding:8px">上位品目（数量）</div><canvas id="cvTopItem" height="110"></canvas></div>
        <div class="card"><div class="muted s" style="padding:8px">月別トレンド（当年）</div><canvas id="cvDashMonth" height="110"></canvas></div>
        <div class="card"><div class="muted s" style="padding:8px">年別推移</div><canvas id="cvDashYear" height="110"></canvas></div>
      </div>
    </section>
  </main>

  <!-- 受注 -->
  <main id="pageSales" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-regular fa-handshake"></i> 受注</h3>
        <div class="row gap">
          <button id="btnSalesCreate" class="btn"><i class="fa-solid fa-plus"></i> 作成</button>
          <input id="salesSearch" placeholder="検索..." class="input">
          <button id="btnSalesImport" class="btn ghost"><i class="fa-solid fa-file-import"></i> Import</button>
          <button id="btnSalesExport" class="btn ghost"><i class="fa-solid fa-file-export"></i> Export</button>
          <button id="btnSalesPrint"  class="btn ghost"><i class="fa-solid fa-print"></i> Print</button>
          <button id="btnSalesTpl" class="btn ghost"><i class="fa-regular fa-file"></i> ひな形CSV</button>
        </div>
      </header>
      <div class="table-wrap" style="max-height:60vh">
        <table class="table s">
          <thead id="thSales"></thead>
          <tbody id="tbSales"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- 生産計画 -->
  <main id="pagePlan" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-solid fa-list-check"></i> 生産計画</h3>
        <div class="row gap">
          <button id="btnPlanCreate" class="btn"><i class="fa-solid fa-plus"></i> 作成</button>
          <input id="planSearch" placeholder="検索..." class="input">
          <button id="btnPlanImport" class="btn ghost"><i class="fa-solid fa-file-import"></i> Import</button>
          <button id="btnPlanExport" class="btn ghost"><i class="fa-solid fa-file-export"></i> Export</button>
          <button id="btnPlanPrint"  class="btn ghost"><i class="fa-solid fa-print"></i> Print</button>
          <button id="btnPlanTpl" class="btn ghost"><i class="fa-regular fa-file"></i> ひな形CSV</button>
        </div>
      </header>
      <div class="table-wrap" style="max-height:60vh">
        <table class="table s">
          <thead id="thPlan"></thead>
          <tbody id="tbPlan"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- 出荷予定 -->
  <main id="pageShip" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-solid fa-truck"></i> 出荷予定</h3>
        <div class="row gap">
          <button id="btnShipCreate" class="btn"><i class="fa-solid fa-plus"></i> 作成</button>
          <input id="shipSearch" placeholder="検索..." class="input">
          <button id="btnShipImport" class="btn ghost"><i class="fa-solid fa-file-import"></i> Import</button>
          <button id="btnShipExport" class="btn ghost"><i class="fa-solid fa-file-export"></i> Export</button>
          <button id="btnShipPrint"  class="btn ghost"><i class="fa-solid fa-print"></i> Print</button>
          <button id="btnShipTpl" class="btn ghost"><i class="fa-regular fa-file"></i> ひな形CSV</button>
        </div>
      </header>
      <div class="table-wrap" style="max-height:60vh">
        <table class="table s">
          <thead id="thShip"></thead>
          <tbody id="tbShip"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- 完成品一覧 -->
  <section id="pageFinished" class="hidden">
    <div class="card">
      <div class="card-head row-between">
        <div class="row gap"><i class="fa-regular fa-box-archive"></i><b>完成品一覧</b></div>
        <div class="row gap">
          <input id="finSearch" class="input" placeholder="検索..." />
          <button id="btnFinExport" class="btn"><i class="fa-regular fa-file-csv"></i> Export</button>
          <button id="btnFinPrint" class="btn"><i class="fa-regular fa-print"></i> Print</button>
        </div>
      </div>
      <div class="table-wrap">
        <table class="table">
          <thead id="thFin"></thead>
          <tbody id="tbFin"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 在庫 -->
  <main id="pageInv" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-solid fa-boxes-stacked"></i> 在庫</h3>
        <div class="row gap">
          <input id="invSearch" placeholder="検索..." class="input">
          <button id="btnInvExport" class="btn ghost"><i class="fa-solid fa-file-export"></i> Export</button>
          <button id="btnInvPrint"  class="btn ghost"><i class="fa-solid fa-print"></i> Print</button>
        </div>
      </header>
      <div class="table-wrap" style="max-height:60vh">
        <table class="table s">
          <thead id="thInv"></thead>
          <tbody id="tbInv"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- ===== 請求書 ===== -->
  <main id="pageInvoice" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-regular fa-file-lines"></i> 請求書作成</h3>
        <div class="row gap">
          <label class="row gap s">得意先
            <select id="invCustSel"></select>
          </label>
          <label class="row gap s">発行日
            <input id="invIssueDate" type="date">
          </label>
          <button id="invRefresh" class="btn ghost"><i class="fa-solid fa-rotate-right"></i> 更新</button>
          <button id="invSave" class="btn"><i class="fa-solid fa-floppy-disk"></i> 保存</button>
          <span class="badge">合計: <span id="invTotal">¥ 0</span></span>
          <button id="invPdf" class="btn ghost"><i class="fa-regular fa-file-pdf"></i> PDF出力</button>
          <button id="invXlsx" class="btn ghost"><i class="fa-regular fa-file-excel"></i> Excel出力</button>
        </div>
      </header>

      <div class="grid" style="grid-template-columns: 1fr 1fr; gap:12px">
        <!-- 未の候補 (checkbox) -->
        <div class="card sub">
          <h4>未（候補）</h4>
          <div class="table-wrap" style="max-height:48vh">
            <table class="table s">
              <thead>
                <tr>
                  <th class="center">選択</th><th>注番</th><th>商品名</th><th>品番</th><th>数量</th><th>単価</th><th>金額</th><th>出荷日</th>
                </tr>
              </thead>
              <tbody id="tbInvCand"></tbody>
            </table>
          </div>
        </div>
        <!-- 全て（ステータス色） -->
        <div class="card sub">
          <h4>得意先内 全件（ステータス）</h4>
          <div class="table-wrap" style="max-height:48vh">
            <table class="table s">
              <thead>
                <tr>
                  <th>注番</th><th>商品名</th><th>品番</th><th>数量</th><th>単価</th><th>金額</th><th>出荷日</th><th>状態</th>
                </tr>
              </thead>
              <tbody id="tbInvAll"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <header class="row-between">
        <h3><i class="fa-regular fa-rectangle-list"></i> 請求書一覧</h3>
      </header>
      <div class="table-wrap" style="max-height:50vh">
        <table class="table s">
          <thead>
            <tr><th>請求書番号</th><th>得意先</th><th>発行日</th><th>合計</th><th>ファイル名</th><th>作成者</th></tr>
          </thead>
          <tbody id="tbInvoiceList"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Dialog: Create / Edit -->
  <dialog id="dlgForm" class="paper">
    <div class="body">
      <h3 id="dlgTitle">作成</h3>
      <form id="formBody" class="grid grid-form"></form>
    </div>
    <footer class="row-end">
      <button class="btn ghost" id="btnDlgCancel">閉じる</button>
      <button class="btn primary" id="btnDlgSave">保存</button>
    </footer>
  </dialog>

  <!-- Dialog: QR Scan -->
  <dialog id="dlgScan" class="paper">
    <div class="body">
      <h3>QRスキャン</h3>
      <video id="scanVideo" playsinline></video>
      <canvas id="scanCanvas" class="hidden"></canvas>
      <div id="scanResult" class="muted s" style="margin-top:.5rem"></div>
    </div>
    <footer class="row-end">
      <button class="btn ghost" id="btnScanStart">開始</button>
      <button class="btn" id="btnScanClose">閉じる</button>
    </footer>
  </dialog>

  <!-- Dialog: 手入力 (OK/NG/工程) -->
  <dialog id="dlgOp" class="paper">
    <div class="body">
      <h3>手入力 <span class="muted s">(PO: <span id="opPO"></span>)</span></h3>
      <div class="grid grid-form">
        <div class="form-item">
          <label for="opProcess">工程 <span class="req">*</span></label>
          <select id="opProcess" required></select>
        </div>
        <div class="form-item">
          <label for="opOK">OK 数 <span class="req">*</span></label>
          <input id="opOK" type="number" min="0" placeholder="必須: 0 以上" required>
        </div>
        <div class="form-item">
          <label for="opNG">NG 数 <span class="req">*</span></label>
          <input id="opNG" type="number" min="0" placeholder="必須: 0 以上" required>
        </div>
        <div class="form-item" style="grid-column:1/-1">
          <div class="muted s">備考</div>
          <input id="opNote" placeholder="備考 (任意)">
        </div>
      </div>
    </div>
    <footer class="row-end">
      <button class="btn ghost" id="btnOpCancel">閉じる</button>
      <button class="btn primary" id="btnOpSave">保存</button>
    </footer>
  </dialog>

  <!-- Tutup dropdown saat klik di luar -->
  <script>
    document.addEventListener('click', (e)=>{
      const dd = document.getElementById('ddSetting');
      if(!dd) return;
      if(!dd.contains(e.target)) dd.removeAttribute('open');
    });
  </script>
</body>
</html>
