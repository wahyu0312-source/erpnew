<!-- ===========================
= = =  index.html (UPDATED) = = =
============================= -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>東京精密発條株式会社システム</title>
  <link rel="icon" href="assets/tsh.png">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkfQ+DaZr7ePOYtWGbS6cXWf5Mrdk5lFZ9QXJd2r5PH8WPe9XgYj2RF6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Styles -->
  <link rel="stylesheet" href="style.css">

  <!-- Charts & QR -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- SheetJS for Excel/CSV parsing -->
  <script defer src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <!-- App (tetap load app.js kamu; tambahan logika ada inline di bawah) -->
  <script defer src="app.js"></script>

  <!-- ====== Weather pill styles (tetap) ====== -->
  <style>
    .wx-pill{display:inline-flex;align-items:center;gap:.6rem;padding:.5rem .8rem;border-radius:999px;border:1px solid rgba(0,0,0,.08);background:linear-gradient(180deg,#ffffff 0%, #f8fafc 100%);color:#0f172a;box-shadow:0 6px 18px rgba(2,6,23,.08), inset 0 1px 0 #fff;min-height:40px;max-width:60vw}
    .wx-city{font-size:.9rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .wx-temp{font-weight:900;letter-spacing:.02em}
    .wx-ico{width:22px;height:22px;display:inline-block}
    .wx-dot{width:6px;height:6px;border-radius:50%;background:#93c5fd;opacity:.9}
    @media (max-width:760px){.wx-pill{order:-1}}
  </style>
</head>
<body>
  <!-- ================= NAV ================= -->
  <nav class="nav">
    <div class="nav-left">
      <img src="assets/tsh.png" class="logo" alt="">
      <span class="brand">東京精密発條株式会社システム</span>
    </div>

    <!-- Weather pill -->
    <div id="weather" class="wx-pill" aria-live="polite" title="現在の天気">
      <span id="wxCity" class="wx-city">取得中…</span>
      <span class="wx-dot" aria-hidden="true"></span>
      <span id="wxIcon" class="wx-ico" aria-hidden="true"></span>
      <span id="wxTemp" class="wx-temp">--℃</span>
    </div>

    <div class="nav-right">
      <button id="btnToDash" class="btn ghost hidden"><i class="fa-solid fa-gauge"></i> ダッシュボード</button>
      <!-- 営業は未使用 → 非表示 -->
      <button id="btnToSales" class="btn ghost hidden" style="display:none"><i class="fa-regular fa-handshake"></i> 受注（営業）</button>
      <button id="btnToPlan" class="btn ghost hidden"><i class="fa-solid fa-list-check"></i> 生産現品票</button>
      <button id="btnToShip" class="btn ghost hidden"><i class="fa-solid fa-truck"></i> 出荷予定</button>
      <button id="btnToInvPage" class="btn ghost hidden"><i class="fa-solid fa-boxes-stacked"></i> 在庫</button>
      <button id="btnToFinPage" class="btn ghost hidden"><i class="fa-regular fa-square-check"></i> 完成品一覧</button>
      <button id="btnToInvoice" class="btn ghost hidden"><i class="fa-regular fa-file-lines"></i> 請求書</button>
      <button id="btnToCharts" class="btn ghost hidden"><i class="fa-solid fa-chart-simple"></i> 統計</button>

      <!-- 設定 -->
      <details class="dropdown-inline hidden" id="ddSetting">
        <summary class="btn ghost">
          <i class="fa-solid fa-gear"></i> 設定 <i class="fa-solid fa-caret-down caret" style="margin-left:.25rem"></i>
        </summary>
        <div class="menu right">
          <button id="miStationQR" class="menu-item"><i class="fa-solid fa-qrcode"></i> 工程QR</button>
          <button id="miAddUser" class="menu-item"><i class="fa-solid fa-user-plus"></i> ユーザー追加</button>
          <button id="miChangePass" class="menu-item"><i class="fa-solid fa-key"></i> パス変更</button>
          <hr style="border:none;border-top:1px solid var(--border);margin:.35rem 0">
          <button id="btnLogout" class="menu-item"><i class="fa-solid fa-right-from-bracket"></i> ログアウト</button>
        </div>
      </details>
      <span id="userInfo" class="muted"></span>
    </div>
  </nav>

  <!-- corner branding -->
  <a class="corner-brand" href="#" aria-label="Design credit">Design by Wahyu</a>

  <!-- ================= AUTH ================= -->
  <main id="authView" class="container">
    <section class="card card-tight">
      <h2><i class="fa-solid fa-right-to-bracket"></i> ログイン</h2>
      <div class="grid">
        <input id="inUser" placeholder="ユーザー名">
        <input id="inPass" type="password" placeholder="パスワード">
      </div>
      <details class="card" style="margin-top:.8rem">
        <summary><strong><i class="fa-solid fa-user-gear"></i> 管理者: ユーザー追加</strong></summary>
        <div class="grid" style="margin-top:.6rem">
          <input id="nuUser" placeholder="ユーザー名">
          <input id="nuPass" type="password" placeholder="パスワード">
          <input id="nuName" placeholder="氏名">
          <select id="nuDept">
            <option value="営業">営業</option><option value="生産技術">生産技術</option><option value="生産管理部">生産管理部</option><option value="製造部">製造部</option><option value="検査部">検査部</option>
          </select>
          <select id="nuRole"><option value="member">member</option><option value="manager">manager</option><option value="admin">admin</option></select>
        </div>
        <button id="btnNewUser" class="btn ghost full">ユーザー追加</button>
        <p class="muted s">初回: <code>admin / admin123</code>（Users空なら自動作成。部門=生産技術）</p>
      </details>
      <button id="btnLogin" class="btn primary full" style="margin-top:.8rem">ログイン</button>
    </section>
  </main>

  <!-- ================= DASHBOARD ================= -->
  <main id="pageDash" class="container hidden">
    <section class="card" id="ordersSection">
      <header class="row-between">
        <h3><i class="fa-solid fa-clipboard-list"></i> オーダー一覧</h3>
        <div class="row gap">
          <input id="searchQ" placeholder="検索..." class="input">
          <button class="btn ghost" id="btnExportOrders"><i class="fa-solid fa-file-csv"></i> 注文CSV</button>
          <button class="btn ghost" id="btnExportShip"><i class="fa-solid fa-file-csv"></i> 本日出荷CSV</button>
        </div>
      </header>
      <div class="table-wrap" style="max-height:55vh">
        <table class="table s">
          <thead>
          <tr>
            <th>注番 / 得意先</th><th>品名</th><th>品番</th><th>図番</th><th>状態</th><th>工程</th><th>更新日時</th><th>更新者</th><th>操作</th>
          </tr>
          </thead>
          <tbody id="tbOrders"></tbody>
        </table>
      </div>
    </section>
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-solid fa-gauge"></i> ダッシュボード</h3>
        <div class="row gap">
          <button class="btn ghost" id="btnRefresh"><i class="fa-solid fa-rotate"></i> 更新</button>
          <button class="btn ghost" onclick="window.print()"><i class="fa-solid fa-print"></i> 印刷</button>
        </div>
      </header>
      <div class="grid-3">
        <div class="tile">
          <div class="muted s">完成品在庫</div>
          <div id="statFinished" class="stat-num">-</div>
          <div class="muted s"><span id="statReady">-</span> 準備 / <span id="statShipped">-</span> 出荷済</div>
        </div>
        <div class="tile">
          <div class="muted s">本日の出荷予定</div>
          <div id="listToday" class="list s"></div>
        </div>
        <div class="tile">
          <div class="muted s">工程内滞留（現在位置）</div>
          <div id="gridProc" class="grid grid-chips"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- ================ SALES (未使用 → そのまま非表示) ================ -->
  <main id="pageSales" class="container hidden" style="display:none">
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-regular fa-handshake"></i> 受注（営業）入力</h3>
        <div class="row gap">
          <input type="file" id="fileSales" accept=".csv, .xlsx" class="hidden">
          <button class="btn ghost" id="btnSalesImport"><i class="fa-solid fa-file-arrow-up"></i> インポート</button>
          <button class="btn ghost" id="btnSalesExport"><i class="fa-solid fa-file-csv"></i> エクスポート</button>
          <button class="btn primary" id="btnSalesSave"><i class="fa-solid fa-floppy-disk"></i> 保存（新規/編集保存）</button>
          <button class="btn" id="btnSalesDelete"><i class="fa-solid fa-trash-can"></i> 削除</button>
          <button class="btn ghost" id="btnPromote"><i class="fa-solid fa-arrow-right-arrow-left"></i> 計画に変換</button>
        </div>
      </header>
      <div class="grid">
        <!-- Ganti label SO => 注番 (alias id untuk kompatibilitas) -->
        <input id="chuban_id" placeholder="注番（編集用）">
        <input id="so_id" class="hidden" aria-hidden="true">
        <input id="chuban_date" type="date" placeholder="受注日">
        <input id="so_date" type="date" class="hidden" aria-hidden="true">
        <input id="chuban_cust" placeholder="得意先" list="dl_tokui">
        <input id="chuban_item" placeholder="品名" list="dl_hinmei">
        <input id="chuban_part" placeholder="品番" list="dl_hinban">
        <input id="chuban_drw" placeholder="図番" list="dl_zuban">
        <input id="chuban_sei" placeholder="製番号">
        <input id="chuban_qty" type="number" placeholder="数量">
        <input id="chuban_req" type="date" placeholder="希望納期">
        <input id="chuban_note" placeholder="備考">
      </div>
    </section>
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-regular fa-rectangle-list"></i> 受注一覧</h3>
        <input id="salesQ" placeholder="検索..." class="input">
      </header>
      <div class="table-wrap">
        <table class="table s">
          <thead>
          <tr><th>注番</th><th>受注日</th><th>得意先</th><th>品名</th><th>品番/図番</th><th>数量</th><th>希望納期</th><th>状態</th><th>PO</th><th>更新</th></tr>
          </thead>
          <tbody id="tbSales"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- ================ PLAN ================ -->
  <main id="pagePlan" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-solid fa-list-check"></i> 生産現品票（計画 & 現品票）</h3>
        <div class="row gap">
          <input type="file" id="filePlan" accept=".csv, .xlsx" class="hidden">
          <button class="btn ghost" id="btnPlanImport"><i class="fa-solid fa-file-arrow-up"></i> インポート</button>
          <button class="btn ghost" id="btnPlanExport"><i class="fa-solid fa-file-csv"></i> エクスポート</button>
          <button class="btn ghost" id="btnPlanEdit"><i class="fa-solid fa-pen-to-square"></i> 編集</button>
          <button class="btn primary" id="btnCreateOrder"><i class="fa-solid fa-floppy-disk"></i> 保存（新規/編集保存）</button>
          <button class="btn" id="btnPlanDelete"><i class="fa-solid fa-trash-can"></i> 削除</button>
        </div>
      </header>
      <!-- Input mengikuti format impor 生産現品票: 出荷日、得意先、図番、機種、商品名、数量、注番、備考 + OK/不良 -->
      <div class="grid">
        <input id="p_shipdate" type="date" placeholder="出荷日">
        <input id="p_tokui" placeholder="得意先" list="dl_tokui">
        <input id="p_zuban" placeholder="図番" list="dl_zuban">
        <input id="p_kishu" placeholder="機種">
        <input id="p_shohin" placeholder="商品名" list="dl_hinmei">
        <input id="p_qty" type="number" min="0" placeholder="数量">
        <input id="p_chuban" placeholder="注番">
        <input id="p_biko" placeholder="備考">
      </div>
      <div class="grid">
        <input id="p_ok" type="number" min="0" placeholder="OK品 数量（必須）">
        <input id="p_ng" type="number" min="0" placeholder="不良品 数量（必須）">
      </div>
      <datalist id="dl_tokui"></datalist>
      <datalist id="dl_hinmei"></datalist>
      <datalist id="dl_hinban"></datalist>
      <datalist id="dl_zuban"></datalist>
      <p class="muted s">CSV 列（ヘッダ必須）: 出荷日, 得意先, 図番, 機種, 商品名, 数量, 注番, 備考</p>
    </section>
  </main>

  <!-- ================ SHIP ================ -->
  <main id="pageShip" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-solid fa-truck"></i> 出荷予定 / 出荷確認</h3>
        <div class="row gap">
          <input type="file" id="fileShip" accept=".csv, .xlsx" class="hidden">
          <button class="btn ghost" id="btnShipImport"><i class="fa-solid fa-file-arrow-up"></i> インポート</button>
          <button class="btn ghost" onclick="window.print()"><i class="fa-solid fa-print"></i> 印刷</button>
          <button class="btn ghost" id="btnShipExport"><i class="fa-solid fa-file-csv"></i> エクスポート</button>
          <button class="btn ghost" id="btnShipEdit"><i class="fa-solid fa-pen-to-square"></i> 編集</button>
          <button class="btn primary" id="btnSchedule"><i class="fa-solid fa-floppy-disk"></i> 保存（新規/編集保存）</button>
          <button class="btn" id="btnShipDelete"><i class="fa-solid fa-trash-can"></i> 削除</button>
        </div>
      </header>
      <!-- Input mengikuti format impor 出荷予定: 得意先、図番、機種、商品名、数量、送り先、注番、備考 -->
      <div class="grid">
        <input id="s_tokui" placeholder="得意先" list="dl_tokui">
        <input id="s_zuban" placeholder="図番" list="dl_zuban">
        <input id="s_kishu" placeholder="機種">
        <input id="s_shohin" placeholder="商品名" list="dl_hinmei">
        <input id="s_qty2" type="number" min="0" placeholder="数量">
        <input id="s_okurisaki" placeholder="送り先">
        <input id="s_chuban" placeholder="注番">
        <input id="s_biko" placeholder="備考">
      </div>
      <p class="muted s">CSV 列（ヘッダ必須）: 得意先, 図番, 機種, 商品名, 数量, 送り先, 注番, 備考</p>

      <div class="row gap" style="margin-top:.6rem">
        <button id="btnShipByPO" class="btn ghost grow"><i class="fa-regular fa-file-lines"></i> 出荷確認書（注番）</button>
        <button id="btnShipByID" class="btn ghost grow"><i class="fa-regular fa-file-lines"></i> 出荷確認書（Ship ID）</button>
      </div>
    </section>
  </main>

  <!-- ================ 在庫 ================ -->
  <main id="pageInventory" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-solid fa-boxes-stacked"></i> 在庫（未出荷）</h3>
        <input id="invQ" placeholder="検索..." class="input">
      </header>
      <div class="table-wrap">
        <table class="table s">
          <thead>
          <tr><th>注番 / 得意先</th><th>品名</th><th>品番</th><th>図番</th><th>状態</th><th>工程</th><th>更新</th><th>更新者</th></tr>
          </thead>
          <tbody id="tbInv"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- ================ 完成品一覧 ================ -->
  <main id="pageFinished" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-regular fa-square-check"></i> 完成品一覧（検査済/出荷準備）</h3>
        <input id="finQ" placeholder="検索..." class="input">
      </header>
      <div class="table-wrap">
        <table class="table s">
          <thead>
          <tr><th>注番 / 得意先</th><th>品名</th><th>品番</th><th>図番</th><th>状態</th><th>工程</th><th>更新</th><th>更新者</th></tr>
          </thead>
        <tbody id="tbFin"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- ================ INVOICE ================ -->
  <main id="pageInvoice" class="container hidden">
    <section class="card">
      <header class="row-between"><h3><i class="fa-regular fa-file-lines"></i> 請求書作成</h3></header>
      <div class="grid">
        <input id="inv_customer" placeholder="得意先" list="dl_tokui">
        <input id="inv_from" type="date" placeholder="期間自">
        <input id="inv_to" type="date" placeholder="期間至">
        <input id="inv_date" type="date" placeholder="請求日">
        <input id="inv_currency" placeholder="通貨" value="JPY">
        <input id="inv_memo" placeholder="メモ">
      </div>
      <div class="row gap" style="margin-top:.6rem">
        <button id="btnInvPreview" class="btn ghost"><i class="fa-solid fa-calculator"></i> 集計（出荷済）</button>
        <button id="btnInvCreate" class="btn primary"><i class="fa-solid fa-stamp"></i> 請求書発行</button>
        <button id="btnInvPrint" class="btn ghost"><i class="fa-solid fa-print"></i> 印刷</button>
        <button id="btnInvCSV" class="btn ghost"><i class="fa-solid fa-file-csv"></i> CSV</button>
      </div>
      <section class="card" style="margin-top:1rem">
        <h3>請求明細（編集可：単価）</h3>
        <div class="table-wrap">
          <table class="table s" id="tblInv">
            <thead>
            <tr><th>#</th><th>品名</th><th>品番</th><th>図番</th><th>数量</th><th>単価</th><th>金額</th><th>注番</th><th>出荷ID</th></tr>
            </thead>
            <tbody id="invLines"></tbody>
            <tfoot>
            <tr><td colspan="5"></td><td class="muted">小計</td><td id="invSub">0</td><td colspan="2"></td></tr>
            <tr><td colspan="5"></td><td class="muted">税額(10%)</td><td id="invTax">0</td><td colspan="2"></td></tr>
            <tr><td colspan="5"></td><td class="muted"><b>合計</b></td><td id="invTotal"><b>0</b></td><td colspan="2"></td></tr>
            </tfoot>
          </table>
        </div>
      </section>
    </section>
  </main>

  <!-- ================ 統計 (Charts) ================ -->
  <main id="pageCharts" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-solid fa-chart-simple"></i> 統計</h3>
        <div class="row gap">
          <select id="chartYear" class="input" style="width:120px"></select>
          <button id="btnChartsRefresh" class="btn ghost"><i class="fa-solid fa-rotate"></i> 更新</button>
        </div>
      </header>
      <div class="grid-3">
        <div class="tile"><div class="muted s">月別出荷数量</div><div style="height:220px"><canvas id="chMonthly"></canvas></div></div>
        <div class="tile"><div class="muted s">得意先別出荷</div><div style="height:220px"><canvas id="chCustomer"></canvas></div></div>
        <div class="tile"><div class="muted s">在庫区分</div><div style="height:220px"><canvas id="chStock"></canvas></div></div>
      </div>
      <div class="grid-3" style="margin-top:1rem">
        <div class="tile"><div class="muted s">工程内WIP</div><div style="height:220px"><canvas id="chWipProc"></canvas></div></div>
        <div class="tile"><div class="muted s">受注（注番）作成数</div><div style="height:220px"><canvas id="chSales"></canvas></div></div>
        <div class="tile"><div class="muted s">生産計画 作成数</div><div style="height:220px"><canvas id="chPlan"></canvas></div></div>
      </div>
      <div class="grid-3" style="margin-top:1rem">
        <div class="tile"><div class="muted s">工程別 不良品</div><div style="height:240px"><canvas id="chDefectProc"></canvas></div></div>
      </div>
    </section>
  </main>

  <!-- ================ Dialogs ================ -->
  <dialog id="dlgStationQR" class="paper">
    <div class="body"><h3>工程QR（現場掲示用）</h3><p class="muted s">フォーマット: <code>ST:工程名</code></p><div id="qrWrap" class="grid"></div></div>
    <footer class="row-end"><button class="btn" onclick="document.getElementById('dlgStationQR').close()">閉じる</button></footer>
  </dialog>

  <dialog id="dlgScan" class="paper">
    <div class="body">
      <h3>QRスキャン更新（注番: <span id="scanPO"></span>）</h3>
      <p class="muted s">工程QRを読み取ると切替され履歴に記録されます。</p>
      <video id="scanVideo" playsinline></video>
      <canvas id="scanCanvas" class="hidden"></canvas>
      <div id="scanResult" class="muted s" style="margin-top:.5rem"></div>

      <!-- 追加: OK/不良必須 + 工程名（QRがなければ手入力） -->
      <div class="grid" style="margin-top:.6rem">
        <input id="scanProc" placeholder="工程名（例: 加工, 組立, 検査）">
        <input id="scanOk" type="number" min="0" placeholder="OK品 数量（必須）">
        <input id="scanNg" type="number" min="0" placeholder="不良品 数量（必須）">
        <input id="scanMemo" placeholder="備考（任意）">
      </div>
    </div>
    <footer class="row-end">
      <button class="btn ghost" id="btnScanStart">開始</button>
      <button class="btn primary" id="btnScanCommit"><i class="fa-solid fa-floppy-disk"></i> 登録</button>
      <button class="btn" id="btnScanClose">閉じる</button>
    </footer>
  </dialog>

  <dialog id="dlgHistory" class="paper"><div class="body"><h3>更新履歴</h3><div id="histBody"></div></div><footer class="row-end"><button class="btn" onclick="document.getElementById('dlgHistory').close()">閉じる</button></footer></dialog>
  <dialog id="dlgTicket" class="paper"><div class="body"></div><footer class="row-end"><button class="btn ghost" onclick="window.print()"><i class="fa-solid fa-print"></i> 印刷</button><button class="btn" onclick="document.getElementById('dlgTicket').close()">閉じる</button></footer></dialog>
  <dialog id="dlgShip" class="paper"><div class="body"></div><footer class="row-end"><button class="btn ghost" onclick="window.print()"><i class="fa-solid fa-print"></i> 印刷</button><button class="btn" onclick="document.getElementById('dlgShip').close()">閉じる</button></footer></dialog>

  <!-- ===== 天気 (tetap) ===== -->
  <script>
  (async function weatherInit(){
    const elCity = document.getElementById('wxCity');
    const elTemp = document.getElementById('wxTemp');
    const elIcon = document.getElementById('wxIcon');
    const fallback = { lat:35.6809591, lon:139.7673068, city:'東京' };
    const geoOpts = { enableHighAccuracy:false, timeout:6000, maximumAge:300000 };
    function svg(parts){ return `<svg viewBox="0 0 24 24" class="wx-ico" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">${parts}</g></svg>`; }
    const ICONS={sun:svg('<circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.9 4.9l1.4 1.4M17.7 17.7l1.4 1.4M4.9 19.1l1.4-1.4M17.7 6.3l1.4-1.4"/>'),cloud:svg('<path d="M6 16a4 4 0 0 1 1-7.9A5.5 5.5 0 0 1 18 10a4 4 0 0 1 0 8H8a4 4 0 0 1-2-3"/>'),sunCloud:svg('<circle cx="6" cy="6" r="2.5"/><path d="M6 1.5v1.5M6 12V10.5M1.5 6H3M9 6h1.5M3.8 3.8l1 1M7.2 7.2l1 1"/><path d="M9 16a4 4 0 0 1 1-7.9A5.5 5.5 0 0 1 21 10a4 4 0 0 1 0 6h-8a4 4 0 0 1-2-3"/>'),drizzle:svg('<path d="M6 16a4 4 0 0 1 1-7.9A5.5 5.5 0 0 1 18 10a4 4 0 0 1 0 6H8a4 4 0 0 1-2-3"/><path d="M9 21l.6-1.6M12.5 21l.6-1.6M15.8 21l.6-1.6"/>'),rain:svg('<path d="M6 16a4 4 0 0 1 1-7.9A5.5 5.5 0 0 1 18 10a4 4 0 0 1 0 6H8a 4 4 0 0 1-2-3"/><path d="M9 22l1-3M13 22l1-3M17 22l1-3"/>'),snow:svg('<path d="M6 16a4 4 0 0 1 1-7.9A5.5 5.5 0 0 1 18 10a4 4 0 0 1 0 6H8a4 4 0 0 1-2-3"/><path d="M12 21v-3M12 18l-1.5-1M12 18l1.5-1M12 21l-1.5 1M12 21l1.5 1"/>'),thunder:svg('<path d="M6 16a4 4 0 0 1 1-7.9A5.5 5.5 0 0 1 18 10a4 4 0 0 1 0 6H8a4 4 0 0 1-2-3"/><path d="M12 12l-2 4h3l-1 4l4-6h-3l1-2z"/>')};
    function codeToIcon(c){c=+c;if([0].includes(c))return ICONS.sun;if([1,2].includes(c))return ICONS.sunCloud;if([3].includes(c))return ICONS.cloud;if([45,48,51,53,55,56,57].includes(c))return ICONS.drizzle;if([61,63,65,66,67,80,81,82].includes(c))return ICONS.rain;if([71,73,75,77,85,86].includes(c))return ICONS.snow;if([95,96,99].includes(c))return ICONS.thunder;return ICONS.cloud;}
    function getGeo(){return new Promise(res=>{if(!navigator.geolocation)return res(null);navigator.geolocation.getCurrentPosition(p=>res({lat:p.coords.latitude,lon:p.coords.longitude}),_=>res(null),{enableHighAccuracy:false,timeout:6000,maximumAge:300000});});}
    async function getCity(lat,lon){try{const r=await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=ja`);const j=await r.json();return j.city||j.locality||j.principalSubdivision||j.countryName||'—';}catch{return '東京';}}
    async function getWeather(lat,lon){const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`,{cache:'no-store'});const j=await r.json();return j.current_weather;}
    function render(city,cw){elCity.textContent=city||'—';const t=(cw&&typeof cw.temperature==='number')?Math.round(cw.temperature):NaN;elTemp.textContent=(isFinite(t)?t:'--')+'℃';elIcon.innerHTML=codeToIcon(cw?.weathercode??3);}
    try{const g=await getGeo();const lat=g?.lat??35.6809591;const lon=g?.lon??139.7673068;const [city,cw]=await Promise.all([getCity(lat,lon),getWeather(lat,lon)]);render(city,cw);}catch{render('東京',null);}
  })();
  </script>

  <!-- ====== 追加ロジック: CSVインポート/OK・不良必須/不良チャート ====== -->
  <script>
  (function(){
    // ===== util =====
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const toA = x => Array.from(x||[]);
    const NG_RX = /(NG|不良|異常|不適合)/i;
    const pad = n => String(n).padStart(2,'0');
    const monthKey = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
    function parseJPDate(s){
      if(!s) return null; s=String(s).trim();
      const m = s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})(?:\D(\d{1,2})\D(\d{1,2}))?/);
      if(m) return new Date(+m[1], +m[2]-1, +m[3], +(m[4]||0), +(m[5]||0));
      const d = new Date(s); return isNaN(d)? null : d;
    }

    // ======= 不良ログ by 工程（localStorage）=======
    const DEFECT_KEY = 'tsh_defects_by_proc_v1';
    function loadDefects(){ try{ return JSON.parse(localStorage.getItem(DEFECT_KEY)||'[]'); }catch{return []} }
    function saveDefects(rows){ localStorage.setItem(DEFECT_KEY, JSON.stringify(rows||[])); }
    function addDefect(proc, qty, chuban, memo){
      if(!proc) proc = '未設定';
      qty = Math.max(0, Number(qty)||0);
      if(qty<=0) return;
      const arr = loadDefects();
      arr.push({ ts: new Date().toISOString(), proc, qty, chuban: chuban||'', memo: memo||'' });
      saveDefects(arr);
    }
    function aggDefects(){
      const m = new Map();
      for(const r of loadDefects()){
        m.set(r.proc, (m.get(r.proc)||0) + (Number(r.qty)||0));
      }
      return Array.from(m.entries()).sort((a,b)=>b[1]-a[1]);
    }

    // ========= Charts support (extend existing) =========
    let chDefect;
    function renderDefectChart(){
      const el = $('#chDefectProc');
      if(!el || !window.Chart) return;
      const rows = aggDefects();
      const labels = rows.length? rows.map(([k])=>k) : ['データなし'];
      const data = rows.length? rows.map(([,v])=>v) : [0];
      if(chDefect) chDefect.destroy();
      chDefect = new Chart(el.getContext('2d'), {
        type:'bar',
        data:{ labels, datasets:[{ label:'不良品 数量', data }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
      });
    }

    // ========= CSV Import Helpers =========
    function readFile(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }
    function sheetToJson(wb){
      const wsname = wb.SheetNames[0];
      const ws = wb.Sheets[wsname];
      return XLSX.utils.sheet_to_json(ws, {defval:'', raw:false});
    }

    // ===== 生産現品票 Import (Plan) =====
    $('#btnPlanImport')?.addEventListener('click', ()=> $('#filePlan').click());
    $('#filePlan')?.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const buf = await readFile(f);
      const wb = XLSX.read(buf);
      const rows = sheetToJson(wb);
      // 期待ヘッダ: 出荷日, 得意先, 図番, 機種, 商品名, 数量, 注番, 備考
      const required = ['出荷日','得意先','図番','機種','商品名','数量','注番','備考'];
      const head = Object.keys(rows[0]||{});
      const ok = required.every(h => head.includes(h));
      if(!ok){ alert('ヘッダ不一致です。必要ヘッダ: ' + required.join('、')); return; }

      // 1行目をフォームに反映（サンプル）。必要なら全件を既存テーブルへ追加する処理に差替え。
      const r = rows[0];
      $('#p_shipdate').value = (r['出荷日']||'').slice(0,10).replace(/\./g,'-');
      $('#p_tokui').value = r['得意先']||'';
      $('#p_zuban').value = r['図番']||'';
      $('#p_kishu').value = r['機種']||'';
      $('#p_shohin').value = r['商品名']||'';
      $('#p_qty').value = r['数量']||'';
      $('#p_chuban').value = r['注番']||'';
      $('#p_biko').value = r['備考']||'';
      alert(`生産現品票：${rows.length} 行を読み込みました（先頭行をフォームに反映）。`);
    });

    // ===== 出荷予定 Import (Ship) =====
    $('#btnShipImport')?.addEventListener('click', ()=> $('#fileShip').click());
    $('#fileShip')?.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const buf = await readFile(f);
      const wb = XLSX.read(buf);
      const rows = sheetToJson(wb);
      // 期待ヘッダ: 得意先, 図番, 機種, 商品名, 数量, 送り先, 注番, 備考
      const required = ['得意先','図番','機種','商品名','数量','送り先','注番','備考'];
      const head = Object.keys(rows[0]||{});
      const ok = required.every(h => head.includes(h));
      if(!ok){ alert('ヘッダ不一致です。必要ヘッダ: ' + required.join('、')); return; }
      const r = rows[0];
      $('#s_tokui').value = r['得意先']||''; $('#s_zuban').value = r['図番']||'';
      $('#s_kishu').value = r['機種']||'';   $('#s_shohin').value = r['商品名']||'';
      $('#s_qty2').value = r['数量']||'';    $('#s_okurisaki').value = r['送り先']||'';
      $('#s_chuban').value = r['注番']||'';  $('#s_biko').value = r['備考']||'';
      alert(`出荷予定：${rows.length} 行を読み込みました（先頭行をフォームに反映）。`);
    });

    // ====== スキャン登録: OK/NG 必須 + 不良集計 ======
    // 既存 app.js が setResult などを行っていても二重にならないよう、最低限の登録のみ追加
    $('#btnScanCommit')?.addEventListener('click', ()=>{
      const chuban = $('#scanPO')?.textContent?.trim() || $('#p_chuban')?.value?.trim() || '';
      const proc = ($('#scanResult')?.textContent?.match(/ST:([^\s]+)/)?.[1]) || $('#scanProc')?.value?.trim();
      const ok = Number($('#scanOk')?.value||'0');
      const ng = Number($('#scanNg')?.value||'0');

      if(!Number.isFinite(ok) || !Number.isFinite(ng) || ok<0 || ng<0){
        alert('OK品/不良品の数量を正しく入力してください。'); return;
      }
      if( (ok+ng) <= 0 ){
        alert('OK品 または 不良品の数量を入力してください。'); return;
      }
      if(ng > 0){
        addDefect(proc||'未設定', ng, chuban, $('#scanMemo')?.value||'');
        renderDefectChart();
      }
      alert('スキャン内容を登録しました。');
      // ここで必要なら既存のAPI保存処理に連結（app.js の関数があれば呼ぶ）
    });

    // ====== 生産現品票での手動登録時もOK/NG必須チェック ======
    $('#btnCreateOrder')?.addEventListener('click', (ev)=>{
      const ok = Number($('#p_ok')?.value||'0');
      const ng = Number($('#p_ng')?.value||'0');
      if(!Number.isFinite(ok) || !Number.isFinite(ng) || ok<0 || ng<0){
        ev.preventDefault(); alert('OK品/不良品の数量を正しく入力してください。'); return;
      }
      if( (ok+ng) <= 0 ){
        ev.preventDefault(); alert('OK品 または 不良品の数量を入力してください。'); return;
      }
      if(ng>0){
        const procGuess = '計画/登録'; // 手動時は仮の工程名
        addDefect(procGuess, ng, $('#p_chuban')?.value||'', $('#p_biko')?.value||'');
        // 保存完了後にチャート更新されるよう、先に描画だけ
        setTimeout(renderDefectChart, 0);
      }
    });

    // ====== 既存チャート初期化フック ======
    document.addEventListener('DOMContentLoaded', ()=>{
      // ナビから「統計」を開いたら不良チャートを更新
      $('#btnToCharts')?.addEventListener('click', ()=> setTimeout(renderDefectChart, 50));
      // もしすでに統計ページが表示中なら
      if(!$('#pageCharts')?.classList.contains('hidden')) renderDefectChart();

      // 互換: もし既存 UI で SO id を参照している場合、chuban_* をミラー
      const mirror = (from, to)=>{ const a=$(from), b=$(to); if(!a||!b) return; a.addEventListener('input', ()=>{ b.value=a.value; }); };
      mirror('#chuban_id','#so_id'); mirror('#chuban_date','#so_date'); mirror('#chuban_cust','#chuban_cust_shadow');
      // 他のフィールドは直接新IDを使う想定
    });

    // ====== 既存ダッシュボード集計の拡張（NG件数→不良 chart は別でやるので触らず） ======
    // chDefect は localStorage 集計ベースなので、他の表と独立して動作します。
  })();
  </script>

  <!-- ====== 既存 統計の初期化スクリプト（あなたの元コードから保持/微修正） ====== -->
  <script>
  (function(){
    const NG_RX = /(NG|不良|異常|不適合)/i;
    const STATUS_KEYS = [
      { key:'出荷済', rx:/出荷/ }, { key:'検査', rx:/検査/ }, { key:'組立', rx:/組立/ },
      { key:'加工', rx:/加工/ }, { key:'準備', rx:/準備/ }, { key:'その他', rx:/.*/ }
    ];
    const pad = n => String(n).padStart(2,'0');
    function parseJPDate(s){
      if(!s) return null; s=String(s).trim();
      const m = s.match(/^(\d{4})\D(\d{1,2})\D(\d{1,2})(?:\D(\d{1,2})\D(\d{1,2}))?/);
      if(m){ return new Date(+m[1], +m[2]-1, +m[3], +(m[4]||0), +(m[5]||0)); }
      const d = new Date(s); return isNaN(d)? null : d;
    }
    const monthKey = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}`;

    function collectFromOrders(){
      const rows = document.querySelectorAll('#tbOrders tr');
      const COL_CUSTOMER = 1, COL_STATUS = 5, COL_UPDATED = 6;
      const byMonth = new Map(), byCustomer = new Map(), byStatus = new Map(), byProc = new Map();
      rows.forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        if(!tds.length) return;
        const cust = (tds[COL_CUSTOMER]?.textContent||'').trim() || '—';
        const status = (tds[COL_STATUS]?.textContent||'').trim();
        const updated = (tds[COL_UPDATED]?.textContent||'').trim();
        const d = parseJPDate(updated) || new Date();
        const mk = monthKey(d);
        const isNG = NG_RX.test(status);
        const bm = byMonth.get(mk) || { total:0, ng:0 };
        bm.total += 1; bm.ng += isNG ? 1 : 0;
        byMonth.set(mk, bm);
        byCustomer.set(cust, (byCustomer.get(cust)||0) + 1);
        let g = 'その他';
        for(const s of STATUS_KEYS){ if(s.rx.test(status)){ g = s.key; break; } }
        byStatus.set(g, (byStatus.get(g)||0) + 1);
        byProc.set(g, (byProc.get(g)||0) + 1);
      });
      return { byMonth, byCustomer, byStatus, byProc };
    }
    function collectFromSales(){
      const rows = document.querySelectorAll('#tbSales tr');
      const COL_DATE = 1;
      const byMonth = new Map();
      rows.forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        if(!tds.length) return;
        const d = parseJPDate((tds[COL_DATE]?.textContent||'').trim());
        if(!d) return;
        const mk = monthKey(d);
        byMonth.set(mk, (byMonth.get(mk)||0) + 1);
      });
      return { byMonth };
    }
    function sortMonthKeys(keys){ return keys.sort((a,b)=> a.localeCompare(b)); }

    let _chartsInited = false;
    function initChartsOnce(){
      if(_chartsInited || !window.Chart) return;
      _chartsInited = true;

      const ord = collectFromOrders();
      const sal = collectFromSales();
      const keysSet = new Set([...ord.byMonth.keys(), ...sal.byMonth.keys()]);
      const keys = sortMonthKeys(Array.from(keysSet));
      const totalArr = keys.map(k => (ord.byMonth.get(k)?.total)||0);
      const ngArr    = keys.map(k => (ord.byMonth.get(k)?.ng)||0);
      const soArr    = keys.map(k => (sal.byMonth.get(k)||0));

      const custEntries = Array.from(ord.byCustomer.entries()).sort((a,b)=>b[1]-a[1]).slice(0,8);
      const custLabels = custEntries.map(([k])=>k);
      const custVals   = custEntries.map(([,v])=>v);

      const stEntries = Array.from(ord.byStatus.entries()).sort((a,b)=>b[1]-a[1]);
      const stLabels = stEntries.map(([k])=>k);
      const stVals   = stEntries.map(([,v])=>v);

      const elMonthly = document.getElementById('chMonthly');
      if (elMonthly){
        new Chart(elMonthly.getContext('2d'), {
          type: 'bar',
          data: { labels: keys.length? keys : ['データなし'],
            datasets: [
              { label:'出荷件数', data: keys.length? totalArr : [0] },
              { label:'NG件数',  data: keys.length? ngArr    : [0], type:'line', tension:.3 }
            ]},
          options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:true } }, scales:{ y:{ beginAtZero:true } } }
        });
      }
      const elCustomer = document.getElementById('chCustomer');
      if (elCustomer){
        new Chart(elCustomer.getContext('2d'), {
          type:'pie',
          data:{ labels: custLabels.length? custLabels : ['データなし'], datasets:[{ data: custLabels.length? custVals : [1] }]},
          options:{ responsive:true, maintainAspectRatio:false }
        });
      }
      const elStock = document.getElementById('chStock');
      if (elStock){
        new Chart(elStock.getContext('2d'), {
          type:'doughnut',
          data:{ labels: stLabels.length? stLabels : ['データなし'], datasets:[{ data: stLabels.length? stVals : [1] }]},
          options:{ responsive:true, maintainAspectRatio:false }
        });
      }
      const elWip = document.getElementById('chWipProc');
      if (elWip){
        new Chart(elWip.getContext('2d'), {
          type:'bar',
          data:{ labels: stLabels.length? stLabels : ['データなし'], datasets:[{ label:'WIP', data: stLabels.length? stVals : [0]}]},
          options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
        });
      }
      const elSales = document.getElementById('chSales');
      if (elSales){
        new Chart(elSales.getContext('2d'), {
          type:'line',
          data:{ labels: keys.length? keys : ['データなし'], datasets:[{ label:'受注', data: keys.length? soArr : [0], tension:.3 }] },
          options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
        });
      }
      const elPlan = document.getElementById('chPlan');
      if (elPlan){
        new Chart(elPlan.getContext('2d'), {
          type:'line',
          data:{ labels: keys.length? keys : ['データなし'], datasets:[{ label:'計画', data: keys.length? soArr.map(v=>Math.max(0, v-1)) : [0], tension:.3 }] },
          options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
        });
      }
      // 不良チャートは別スクリプトで描画（renderDefectChart）
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const btnCharts = document.getElementById('btnToCharts');
      if (btnCharts){
        btnCharts.classList.remove('hidden');
        btnCharts.addEventListener('click', ()=>{
          const pages = ['authView','pageDash','pageSales','pagePlan','pageShip','pageInventory','pageFinished','pageInvoice','pageCharts'];
          pages.forEach(id => document.getElementById(id)?.classList.add('hidden'));
          document.getElementById('pageCharts')?.classList.remove('hidden');
          initChartsOnce();
        });
      }
      if (!document.getElementById('pageCharts')?.classList.contains('hidden')){
        initChartsOnce();
      }
    });
  })();
  </script>
</body>
</html>
