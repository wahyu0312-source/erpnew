<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>東京精密発條株式会社システム</title>
  <link rel="icon" href="assets/tsh.png">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkfQ+DaZr7ePOYtWGbS6cXWf5Mrdk5lFZ9QXJd2r5PH8WPe9XgYj2RF6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="style.css">

  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script defer src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <script defer src="app.js"></script>

  <!-- Weather pill (ringan, tanpa API key) -->
  <style>
    .wx-pill{display:inline-flex;align-items:center;gap:.6rem;padding:.5rem .8rem;border-radius:999px;border:1px solid rgba(0,0,0,.08);background:linear-gradient(180deg,#ffffff 0%, #f8fafc 100%);color:#0f172a;box-shadow:0 6px 18px rgba(2,6,23,.08), inset 0 1px 0 #fff;min-height:40px;max-width:60vw}
    .wx-city{font-size:.9rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .wx-temp{font-weight:900;letter-spacing:.02em}
    .wx-ico{width:22px;height:22px;display:inline-block}
    .wx-dot{width:6px;height:6px;border-radius:50%;background:#93c5fd;opacity:.9}
    @media (max-width:760px){.wx-pill{order:-1}}
  </style>
</head>
<body>
  <!-- ================= NAV ================= -->
  <nav class="nav">
    <div class="nav-left">
      <img src="assets/tsh.png" class="logo" alt="">
      <span class="brand">東京精密発條株式会社システム</span>
    </div>

    <!-- Weather pill -->
    <div id="weather" class="wx-pill" aria-live="polite" title="現在の天気">
      <span id="wxCity" class="wx-city">取得中…</span>
      <span class="wx-dot" aria-hidden="true"></span>
      <span id="wxIcon" class="wx-ico" aria-hidden="true"></span>
      <span id="wxTemp" class="wx-temp">--℃</span>
    </div>

    <div class="nav-right">
      <button id="btnToDash" class="btn ghost hidden"><i class="fa-solid fa-gauge"></i> ダッシュボード</button>
      <button id="btnToSales" class="btn ghost hidden" style="display:none"><i class="fa-regular fa-handshake"></i> 受注（営業）</button>
      <button id="btnToPlan" class="btn ghost hidden"><i class="fa-solid fa-list-check"></i> 生産現品票</button>
      <button id="btnToShip" class="btn ghost hidden"><i class="fa-solid fa-truck"></i> 出荷予定</button>
      <button id="btnToInvPage" class="btn ghost hidden"><i class="fa-solid fa-boxes-stacked"></i> 在庫</button>
      <button id="btnToFinPage" class="btn ghost hidden"><i class="fa-regular fa-square-check"></i> 完成品一覧</button>
      <button id="btnToInvoice" class="btn ghost hidden"><i class="fa-regular fa-file-lines"></i> 請求書</button>
      <button id="btnToCharts" class="btn ghost hidden"><i class="fa-solid fa-chart-simple"></i> 統計</button>

      <!-- 設定 -->
      <details class="dropdown-inline hidden" id="ddSetting">
        <summary class="btn ghost">
          <i class="fa-solid fa-gear"></i> 設定 <i class="fa-solid fa-caret-down caret" style="margin-left:.25rem"></i>
        </summary>
        <div class="menu right">
          <button id="miStationQR" class="menu-item"><i class="fa-solid fa-qrcode"></i> 工程QR</button>
          <button id="miAddUser" class="menu-item"><i class="fa-solid fa-user-plus"></i> ユーザー追加</button>
          <button id="miChangePass" class="menu-item"><i class="fa-solid fa-key"></i> パス変更</button>
          <hr style="border:none;border-top:1px solid var(--border);margin:.35rem 0">
          <button id="btnLogout" class="menu-item"><i class="fa-solid fa-right-from-bracket"></i> ログアウト</button>
        </div>
      </details>
      <span id="userInfo" class="muted"></span>
    </div>
  </nav>

  <a class="corner-brand" href="#" aria-label="Design credit">Design by Wahyu</a>

  <!-- ================= AUTH ================= -->
  <main id="authView" class="container">
    <section class="card card-tight">
      <h2><i class="fa-solid fa-right-to-bracket"></i> ログイン</h2>
      <div class="grid">
        <input id="inUser" placeholder="ユーザー名">
        <input id="inPass" type="password" placeholder="パスワード">
      </div>

      <button id="btnLogin" class="btn primary full" style="margin-top:.8rem">ログイン</button>
      <p class="muted s" style="margin-top:.5rem">初回: <code>admin / admin123</code>（Users空なら自動作成。部門=生産技術）</p>
    </section>
  </main>

  <!-- ================= DASHBOARD ================= -->
  <main id="pageDash" class="container hidden">
    <section class="card" id="ordersSection">
      <header class="row-between">
        <h3><i class="fa-solid fa-clipboard-list"></i> オーダー一覧</h3>
        <div class="row gap">
          <input id="searchQ" placeholder="検索..." class="input">
          <button class="btn ghost" id="btnExportOrders"><i class="fa-solid fa-file-csv"></i> 注文CSV</button>
          <button class="btn ghost" id="btnExportShip"><i class="fa-solid fa-file-csv"></i> 本日出荷CSV</button>
        </div>
      </header>
      <div class="table-wrap" style="max-height:55vh">
        <table class="table s">
          <thead>
          <tr>
            <th>注番 / 得意先</th><th>品名</th><th>品番</th><th>図番</th><th>数量</th><th>状態</th><th>工程</th><th>更新日時</th><th>更新者</th><th>操作</th>
          </tr>
          </thead>
          <tbody id="tbOrders"></tbody>
        </table>
      </div>
    </section>
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-solid fa-gauge"></i> ダッシュボード</h3>
        <div class="row gap">
          <button class="btn ghost" id="btnRefresh"><i class="fa-solid fa-rotate"></i> 更新</button>
          <button class="btn ghost" onclick="window.print()"><i class="fa-solid fa-print"></i> 印刷</button>
        </div>
      </header>
      <div class="grid-3">
        <div class="tile">
          <div class="muted s">完成品在庫</div>
          <div id="statFinished" class="stat-num">-</div>
          <div class="muted s"><span id="statReady">-</span> 準備 / <span id="statShipped">-</span> 出荷済</div>
        </div>
        <div class="tile">
          <div class="muted s">本日の出荷予定</div>
          <div id="listToday" class="list s"></div>
        </div>
        <div class="tile">
          <div class="muted s">工程内滞留（現在位置）</div>
          <div id="gridProc" class="grid grid-chips"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- ================ PLAN: 生産現品票 ================ -->
  <main id="pagePlan" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-solid fa-list-check"></i> 生産現品票（計画 & 登録）</h3>
        <div class="row gap">
          <input type="file" id="filePlan" accept=".csv, .xlsx" class="hidden">
          <button class="btn ghost" id="btnPlanImport"><i class="fa-solid fa-file-arrow-up"></i> インポート</button>
          <button class="btn primary" id="btnCreateOrder"><i class="fa-solid fa-floppy-disk"></i> 保存</button>
        </div>
      </header>
      <!-- Form mengikuti header CSV: 出荷日、得意先、図番、機種、商品名、数量、注番、備考 -->
      <div class="grid">
        <input id="p_shipdate" type="date" placeholder="出荷日">
        <input id="p_tokui" placeholder="得意先" list="dl_tokui">
        <input id="p_zuban" placeholder="図番" list="dl_zuban">
        <input id="p_kishu" placeholder="機種">
        <input id="p_shohin" placeholder="商品名" list="dl_hinmei">
        <input id="p_qty" type="number" min="0" placeholder="数量">
        <input id="p_chuban" placeholder="注番">
        <input id="p_biko" placeholder="備考">
      </div>
      <div class="grid">
        <input id="p_ok" type="number" min="0" placeholder="OK品 数量（必須）">
        <input id="p_ng" type="number" min="0" placeholder="不良品 数量（必須）">
      </div>
      <datalist id="dl_tokui"></datalist>
      <datalist id="dl_hinmei"></datalist>
      <datalist id="dl_hinban"></datalist>
      <datalist id="dl_zuban"></datalist>
      <p class="muted s">CSV 列（ヘッダ必須）: 出荷日, 得意先, 図番, 機種, 商品名, 数量, 注番, 備考</p>
    </section>
  </main>

  <!-- ================ SHIP: 出荷予定 ================ -->
  <main id="pageShip" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-solid fa-truck"></i> 出荷予定 / 出荷確認</h3>
        <div class="row gap">
          <input type="file" id="fileShip" accept=".csv, .xlsx" class="hidden">
          <button class="btn ghost" id="btnShipImport"><i class="fa-solid fa-file-arrow-up"></i> インポート</button>
          <button class="btn primary" id="btnSchedule"><i class="fa-solid fa-floppy-disk"></i> 保存</button>
        </div>
      </header>
      <!-- Form mengikuti header CSV: 得意先、図番、機種、商品名、数量、送り先、注番、備考 -->
      <div class="grid">
        <input id="s_tokui" placeholder="得意先" list="dl_tokui">
        <input id="s_zuban" placeholder="図番" list="dl_zuban">
        <input id="s_kishu" placeholder="機種">
        <input id="s_shohin" placeholder="商品名" list="dl_hinmei">
        <input id="s_qty2" type="number" min="0" placeholder="数量">
        <input id="s_okurisaki" placeholder="送り先">
        <input id="s_chuban" placeholder="注番">
        <input id="s_biko" placeholder="備考">
      </div>
      <p class="muted s">CSV 列（ヘッダ必須）: 得意先, 図番, 機種, 商品名, 数量, 送り先, 注番, 備考</p>
    </section>
  </main>

  <!-- ================ 完成品・在庫・請求など (dipersingkat tampilan) ================ -->
  <main id="pageCharts" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3><i class="fa-solid fa-chart-simple"></i> 統計</h3>
        <div class="row gap">
          <button id="btnChartsRefresh" class="btn ghost"><i class="fa-solid fa-rotate"></i> 更新</button>
        </div>
      </header>
      <div class="grid-3">
        <div class="tile"><div class="muted s">工程別 不良品</div><div style="height:240px"><canvas id="chDefectProc"></canvas></div></div>
      </div>
    </section>
  </main>

  <!-- ===== 天気 (tanpa API key) ===== -->
  <script>
  (async function weatherInit(){
    const elCity = document.getElementById('wxCity');
    const elTemp = document.getElementById('wxTemp');
    const elIcon = document.getElementById('wxIcon');
    const fallback = { lat:35.6809591, lon:139.7673068, city:'東京' };
    function svg(parts){ return `<svg viewBox="0 0 24 24" class="wx-ico" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><g fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">${parts}</g></svg>`; }
    const ICONS={sun:svg('<circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.9 4.9l1.4 1.4M17.7 17.7l1.4 1.4M4.9 19.1l1.4-1.4M17.7 6.3l1.4-1.4"/>'),cloud:svg('<path d="M6 16a4 4 0 0 1 1-7.9A5.5 5.5 0 0 1 18 10a4 4 0 0 1 0 8H8a4 4 0 0 1-2-3"/>'),sunCloud:svg('<circle cx="6" cy="6" r="2.5"/><path d="M6 1.5v1.5M6 12V10.5M1.5 6H3M9 6h1.5M3.8 3.8l1 1M7.2 7.2l1 1"/><path d="M9 16a4 4 0 0 1 1-7.9A5.5 5.5 0 0 1 21 10a4 4 0 0 1 0 6h-8a4 4 0 0 1-2-3"/>'),drizzle:svg('<path d="M6 16a4 4 0 0 1 1-7.9A5.5 5.5 0 0 1 18 10a4 4 0 0 1 0 6H8a4 4 0 0 1-2-3"/><path d="M9 21l.6-1.6M12.5 21l.6-1.6M15.8 21l.6-1.6"/>')};
    async function getWeather(lat,lon){const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`,{cache:'no-store'});const j=await r.json();return j.current_weather;}
    try{
      const lat=fallback.lat, lon=fallback.lon; // pakai fallback agar simpel/stabil
      const cw=await getWeather(lat,lon);
      elCity.textContent='東京'; elTemp.textContent=(Math.round(cw?.temperature??NaN)||'--')+'℃';
      elIcon.innerHTML=ICONS.sunCloud;
    }catch{ elCity.textContent='東京'; elTemp.textContent='--℃'; }
  })();
  </script>
</body>
</html>
