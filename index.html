<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>生産ダッシュボード</title>
  <link rel="icon" href="assets/logo.png">
  <link rel="stylesheet" href="style.css">
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script defer src="app.js"></script>
</head>
<body>
  <nav class="nav">
    <div class="nav-left">
      <img src="assets/logo.png" class="logo" alt="Logo">
      <span class="brand">生産ミニERP</span>
    </div>
    <div class="nav-right">
      <button id="btnToDash" class="btn ghost hidden">ダッシュボード</button>
      <button id="btnToPlan" class="btn ghost hidden">生産計画</button>
      <button id="btnToShip" class="btn ghost hidden">出荷予定</button>
      <button id="btnScan" class="btn ghost hidden">スキャン更新</button>
      <span id="userInfo" class="muted"></span>
      <button id="btnAddUserWeb" class="btn ghost hidden">ユーザー追加</button>
      <button id="btnChangePass" class="btn ghost hidden">パスワード変更</button>
      <button id="btnLogout" class="btn ghost hidden">ログアウト</button>
    </div>
  </nav>

  <!-- 認証 -->
  <main id="authView" class="container">
    <section class="card card-tight">
      <h2>ログイン（スプレッドシートDB）</h2>
      <div class="grid">
        <input id="inUser" placeholder="ユーザー名">
        <input id="inPass" type="password" placeholder="パスワード">
      </div>
      <details class="card" style="margin-top:.8rem">
        <summary><strong>管理者: ユーザー追加</strong></summary>
        <div class="grid" style="margin-top:.6rem">
          <input id="nuUser" placeholder="ユーザー名">
          <input id="nuPass" type="password" placeholder="パスワード">
          <input id="nuName" placeholder="氏名">
          <select id="nuDept">
            <option value="生産管理部">生産管理部</option>
            <option value="製造部">製造部</option>
            <option value="検査部">検査部</option>
          </select>
          <select id="nuRole">
            <option value="member">member</option>
            <option value="manager">manager</option>
            <option value="admin">admin</option>
          </select>
        </div>
        <button id="btnNewUser" class="btn ghost full">ユーザー追加</button>
        <p class="muted s">初回は <code>admin/admin123</code>（Users シートが空の場合に自動作成）。</p>
      </details>
      <div class="row gap" style="margin-top:.8rem">
        <button id="btnLogin" class="btn primary grow">ログイン</button>
      </div>
    </section>
  </main>

  <!-- ページ：ダッシュボード -->
  <main id="pageDash" class="container hidden">
    <section class="card">
      <header class="row-between">
        <h3>ダッシュボード</h3>
        <div class="row gap">
          <button class="btn ghost" id="btnRefresh">更新</button>
          <button class="btn ghost" onclick="window.print()">印刷</button>
        </div>
      </header>
      <div class="grid-3">
        <div class="stat">
          <div class="muted s">完成品在庫</div>
          <div id="statFinished" class="stat-num">-</div>
          <div class="muted s"><span id="statReady">-</span> 準備 • <span id="statShipped">-</span> 出荷済</div>
        </div>
        <div class="tile">
          <div class="muted s">本日の出荷予定</div>
          <div id="listToday" class="list s"></div>
        </div>
        <div class="tile">
          <div class="muted s">工程内滞留（現在位置）</div>
          <div id="gridProc" class="grid grid-chips"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>チャート</h3>
      <canvas id="chartMonthly" height="160"></canvas>
      <hr>
      <canvas id="chartCustomer" height="160"></canvas>
      <hr>
      <canvas id="chartStock" height="160"></canvas>
    </section>

    <section class="card">
      <header class="row-between">
        <h3>オーダー一覧</h3>
        <div class="row gap">
          <input id="searchQ" placeholder="検索..." class="input">
          <button class="btn ghost" id="btnExportOrders">注文CSV</button>
          <button class="btn ghost" id="btnExportShip">本日出荷CSV</button>
        </div>
      </header>
      <div class="table-wrap">
        <table class="table s">
          <thead>
            <tr>
              <th>PO</th><th>得意先</th><th>製番号</th><th>品名</th><th>品番</th><th>図番</th>
              <th>状態</th><th>工程</th><th>更新日時</th><th>更新者</th><th>操作</th>
            </tr>
          </thead>
          <tbody id="tbOrders"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- ページ：生産計画 -->
  <main id="pagePlan" class="container hidden">
    <section class="card">
      <h3>生産計画（生産現品票 発行）</h3>
      <div class="grid">
        <input id="c_tsuchi" placeholder="通知書番号">
        <input id="c_tokui" placeholder="得意先" list="dl_tokui">
        <input id="c_tokui_hin" placeholder="得意先品番">
        <input id="c_sei" placeholder="製番号">
        <input id="c_hinmei" placeholder="品名" list="dl_hinmei">
        <input id="c_hinban" placeholder="品番" list="dl_hinban">
        <input id="c_zuban" placeholder="図番" list="dl_zuban">
        <input id="c_kanri" placeholder="管理No">
      </div>
      <datalist id="dl_tokui"></datalist>
      <datalist id="dl_hinmei"></datalist>
      <datalist id="dl_hinban"></datalist>
      <datalist id="dl_zuban"></datalist>
      <button id="btnCreateOrder" class="btn primary full">生産現品票 発行</button>
    </section>
  </main>

  <!-- ページ：出荷予定 -->
  <main id="pageShip" class="container hidden">
    <section class="card">
      <h3>出荷予定の作成</h3>
      <div class="grid">
        <input id="s_po" placeholder="PO ID">
        <input id="s_date" type="date">
        <input id="s_qty" type="number" min="0" placeholder="数量">
      </div>
      <div class="row gap">
        <button id="btnSchedule" class="btn primary grow">登録</button>
        <button id="btnShipByPO" class="btn ghost grow">出荷確認書（PO）</button>
        <button id="btnShipByID" class="btn ghost grow">出荷確認書（Ship ID）</button>
      </div>
    </section>
  </main>

  <!-- モーダル：QRスキャン -->
  <dialog id="dlgScan" class="paper">
    <div class="body">
      <h3>QRスキャンでステータス更新</h3>
      <div class="grid">
        <select id="scanStatus">
          <option>生産開始</option>
          <option>検査保留</option>
          <option>検査済</option>
          <option>出荷準備</option>
          <option>出荷済</option>
          <option>不良品（要リペア）</option>
        </select>
        <select id="scanProcess">
          <option>レーザ加工</option><option>曲げ加工</option><option>外枠組立</option>
          <option>シャッター組立</option><option>シャッター溶接</option><option>コーキング</option>
          <option>外枠塗装</option><option>組立（組立中）</option><option>組立（組立済）</option>
          <option>外注</option><option>検査工程</option>
        </select>
      </div>
      <p class="muted s">QRの内容：<code>PO-xxxxxxxxxxxx</code>（PO ID）</p>
      <video id="scanVideo" playsinline></video>
      <canvas id="scanCanvas" class="hidden"></canvas>
      <div id="scanResult" class="muted s" style="margin-top:.5rem"></div>
    </div>
    <footer class="row-end">
      <button class="btn ghost" id="btnScanStart">開始</button>
      <button class="btn" id="btnScanClose">閉じる</button>
    </footer>
  </dialog>

  <!-- モーダル：票 -->
  <dialog id="dlgTicket" class="paper"><div class="body"></div><footer class="row-end"><button class="btn ghost" onclick="window.print()">印刷</button><button class="btn" onclick="document.getElementById('dlgTicket').close()">閉じる</button></footer></dialog>
  <dialog id="dlgShip" class="paper"><div class="body"></div><footer class="row-end"><button class="btn ghost" onclick="window.print()">印刷</button><button class="btn" onclick="document.getElementById('dlgShip').close()">閉じる</button></footer></dialog>
</body>
</html>
