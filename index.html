<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>東京精密発條株式会社システム</title>

  <!-- Preconnect untuk percepat CDN/API -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://script.google.com" crossorigin>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --brand:#0ea5a6; --ink:#0f172a; --muted:#64748b; --bg:#f6f7fb;
      --panel:#fff; --border:#e5e7eb; --ring:#c7d2fe; --btn:#109293;
      --radius:14px; --shadow:0 8px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic",sans-serif;background:var(--bg);color:var(--ink)}
    a{color:inherit;text-decoration:none}
    .hidden{display:none !important}
    .muted{color:var(--muted)}
    .s{font-size:12px}
    .row{display:flex;gap:8px;align-items:center}
    .row-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .wrap{display:flex;flex-wrap:wrap;gap:8px}
    .btn{display:inline-flex;align-items:center;gap:.45rem;border:1px solid var(--border);background:#fff;padding:.5rem .75rem;border-radius:999px;cursor:pointer}
    .btn.ghost{background:#fff}
    .btn.primary{background:var(--btn);border-color:var(--btn);color:#fff}
    .btn.icon i{width:1.1em;text-align:center}
    .chip{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .6rem;border-radius:999px;background:#f1f5f9}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{border-top:1px solid var(--border);padding:10px;text-align:left;vertical-align:top;background:#fff}
    th{position:sticky;top:0;background:#f8fafc;z-index:1}

    /* ===== Top bar ===== */
    .topbar{position:sticky;top:0;z-index:50;background:#0ea5a6;color:#fff}
    .topbar-inner{
      height:56px;display:flex;align-items:center;gap:12px;padding:0 10px;
    }
    .brand{display:flex;align-items:center;gap:.5rem;font-weight:700}
    .brand i{opacity:.9}
    .top-right{
      margin-left:auto; /* dorong semua ke sisi kanan */
      display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;min-width:0;
    }
    .nav{display:flex;gap:8px;align-items:center;flex-wrap:nowrap;overflow:auto;max-width:100%}
    .nav .btn{background:#0fb1b3;color:#fff;border-color:#0fb1b3;white-space:nowrap}
    .wx{display:flex;gap:8px;align-items:center}
    .userwrap{display:flex;gap:8px;align-items:center}
    main{max-width:1400px;margin:18px auto;padding:0 14px 60px}

    /* Auth card */
    #authView .card{max-width:520px;margin:60px auto}
    input,select{height:36px;border:1px solid var(--border);border-radius:10px;padding:0 .7rem;background:#fff}
    input[type="date"]{padding:.25rem .6rem}
    .form-item{display:grid;gap:6px;margin:8px 0}
    dialog.dlg{border:0;border-radius:16px;box-shadow:var(--shadow);padding:14px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:900px){
      .grid2{grid-template-columns:1fr}
      .nav{order:3;width:100%} /* menu tetap ke kanan, tapi mengalir di baris baru */
      .top-right{gap:8px}
    }

    /* sentuhan kecil untuk keterbacaan */
    .table-wrap::-webkit-scrollbar{height:8px}
    .table-wrap::-webkit-scrollbar-thumb{background:#e2e8f0;border-radius:999px}
  </style>
</head>
<body>

  <!-- ======= TOP BAR ======= -->
  <div class="topbar hidden" id="topBar">
    <div class="topbar-inner">
      <!-- Kiri: brand kecil; menu dipindah ke kanan -->
      <div class="brand">
        <i class="fa-solid fa-screwdriver-wrench"></i>
        <span>TSH System</span>
      </div>

      <!-- Kanan: menu + cuaca + user + logout -->
      <div class="top-right">
        <div class="nav" id="navBtns">
          <button class="btn" id="btnToDash"><i class="fa-solid fa-gauge"></i> ダッシュボード</button>
          <button class="btn" id="btnToSales"><i class="fa-regular fa-clipboard"></i> 受注</button>
          <button class="btn" id="btnToPlan"><i class="fa-solid fa-list-check"></i> 生産計画</button>
          <button class="btn" id="btnToShip"><i class="fa-solid fa-truck"></i> 出荷予定</button>
          <button class="btn" id="btnToFinPage"><i class="fa-regular fa-circle-check"></i> 完成品一覧</button>
          <button class="btn" id="btnToInvPage"><i class="fa-solid fa-boxes-stacked"></i> 在庫</button>
          <button class="btn" id="btnToInvoice"><i class="fa-regular fa-file-lines"></i> 請求書</button>
          <button class="btn" id="btnToAnalytics"><i class="fa-solid fa-chart-line"></i> 分析チャート</button>
          <div class="btn" id="ddSetting">
            <i class="fa-solid fa-gear"></i> 設定
            <div class="chip" style="background:#0fb1b3;color:#fff;cursor:pointer" id="btnStationQR">工程QR</div>
          </div>
        </div>

        <div class="wx hidden" id="weatherWrap" aria-label="現在の天気">
          <i class="fa-regular fa-sun"></i>
          <span id="wxTemp">—</span>
          <span class="s muted">/</span>
          <span id="wxWind">—</span>
          <span class="s muted">·</span>
          <span id="wxPlace" class="s">—</span>
        </div>

        <div class="userwrap">
          <div class="s" id="userInfo"> </div>
          <button class="btn ghost" id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i> ログアウト</button>
        </div>
      </div>
    </div>
  </div>

  <main>
    <!-- ======= LOGIN ======= -->
    <section id="authView">
      <div class="card">
        <h3 style="margin:0 0 12px"><i class="fa-solid fa-right-to-bracket"></i> ログイン</h3>
        <div class="form-item">
          <div class="s muted">ユーザー名</div>
          <input id="inUser" placeholder="ユーザー名" autocomplete="username">
        </div>
        <div class="form-item">
          <div class="s muted">パスワード</div>
          <input id="inPass" type="password" placeholder="パスワード" autocomplete="current-password">
        </div>
        <div class="row" style="margin-top:10px">
          <button id="btnLogin" class="btn primary">ログイン</button>
          <div class="s muted">※上部メニューはログイン後に表示されます。</div>
        </div>
      </div>
    </section>

    <!-- ======= DASHBOARD ======= -->
    <section id="pageDash" class="hidden">
      <div class="card">
        <div class="row-between">
          <h3 style="margin:0">生産計画</h3>
          <div class="toolbar">
            <input id="searchQ" placeholder="検索…">
            <button class="btn" id="btnExportOrders"><i class="fa-regular fa-file-excel"></i> Export</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>注番/得意先</th><th>品名</th><th>品番</th><th>図番</th>
                <th>状態</th><th>工程</th><th>更新</th><th>更新者</th><th>操作</th>
              </tr>
            </thead>
            <tbody id="tbOrders"></tbody>
          </table>
        </div>
      </div>

      <div class="grid2" style="margin-top:14px">
        <div class="card">
          <h4 style="margin:0 0 10px">本日出荷</h4>
          <div id="shipToday" class="s muted">—</div>
        </div>
        <div class="card">
          <h4 style="margin:0 0 10px">出荷予定</h4>
          <div id="shipPlan" class="s muted">—</div>
        </div>
      </div>
    </section>

    <!-- ======= SALES ======= -->
    <section id="pageSales" class="hidden">
      <div class="card">
        <div class="row-between">
          <h3 style="margin:0">受注</h3>
          <div class="toolbar">
            <input id="salesSearch" placeholder="検索…">
            <button class="btn" id="btnSalesCreate"><i class="fa-solid fa-plus"></i> 作成</button>
            <button class="btn" id="btnSalesImport"><i class="fa-solid fa-upload"></i> Import</button>
            <button class="btn" id="btnSalesExport"><i class="fa-regular fa-file-excel"></i> Export</button>
            <button class="btn" id="btnSalesPrint"><i class="fa-solid fa-print"></i> Print</button>
            <button class="btn" id="btnSalesTpl"><i class="fa-regular fa-file"></i> 雛形CSV</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead id="thSales"></thead>
            <tbody id="tbSales"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ======= PLAN ======= -->
    <section id="pagePlan" class="hidden">
      <div class="card">
        <div class="row-between">
          <h3 style="margin:0">生産計画</h3>
          <div class="toolbar">
            <input id="planSearch" placeholder="検索…">
            <button class="btn" id="btnPlanCreate"><i class="fa-solid fa-plus"></i> 作成</button>
            <button class="btn" id="btnPlanImport"><i class="fa-solid fa-upload"></i> Import</button>
            <button class="btn" id="btnPlanExport"><i class="fa-regular fa-file-excel"></i> Export</button>
            <button class="btn" id="btnPlanPrint"><i class="fa-solid fa-print"></i> Print</button>
            <button class="btn" id="btnPlanTpl"><i class="fa-regular fa-file"></i> 雛形CSV</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead id="thPlan"></thead>
            <tbody id="tbPlan"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ======= SHIP ======= -->
    <section id="pageShip" class="hidden">
      <div class="card">
        <div class="row-between">
          <h3 style="margin:0">出荷予定</h3>
          <div class="toolbar">
            <input id="shipSearch" placeholder="検索…">
            <button class="btn" id="btnShipCreate"><i class="fa-solid fa-plus"></i> 作成</button>
            <button class="btn" id="btnShipImport"><i class="fa-solid fa-upload"></i> Import</button>
            <button class="btn" id="btnShipExport"><i class="fa-regular fa-file-excel"></i> Export</button>
            <button class="btn" id="btnShipPrint"><i class="fa-solid fa-print"></i> Print</button>
            <button class="btn" id="btnShipTpl"><i class="fa-regular fa-file"></i> 雛形CSV</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead id="thShip"></thead>
            <tbody id="tbShip"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ======= FINISHED ======= -->
    <section id="pageFinished" class="hidden">
      <div class="card">
        <div class="row-between">
          <h3 style="margin:0">完成品一覧</h3>
          <div class="toolbar">
            <input id="finSearch" placeholder="検索…">
            <button class="btn" id="btnFinExport"><i class="fa-regular fa-file-excel"></i> Export</button>
            <button class="btn" id="btnFinPrint"><i class="fa-solid fa-print"></i> Print</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead id="thFin"></thead>
            <tbody id="tbFin"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ======= INVENTORY ======= -->
    <section id="pageInv" class="hidden">
      <div class="card">
        <div class="row-between">
          <h3 style="margin:0">在庫</h3>
          <div class="toolbar">
            <input id="invSearch" placeholder="検索…">
            <button class="btn" id="btnInvExport"><i class="fa-regular fa-file-excel"></i> Export</button>
            <button class="btn" id="btnInvPrint"><i class="fa-solid fa-print"></i> Print</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead id="thInv"></thead>
            <tbody id="tbInv"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ======= INVOICE ======= -->
    <section id="pageInvoice" class="hidden">
      <div class="card">
        <div class="row-between">
          <h3 style="margin:0">請求書作成</h3>
          <div class="toolbar">
            <select id="invoiceCustomer" style="min-width:220px"><option value="">(得意先を選択)</option></select>
            <input id="invoiceDate" type="date">
            <button class="btn" id="btnInvoiceReload"><i class="fa-solid fa-rotate"></i> 更新</button>
            <button class="btn primary" id="btnInvoiceSave"><i class="fa-regular fa-floppy-disk"></i> 保存</button>
            <button class="btn" id="btnInvoicePdf"><i class="fa-regular fa-file-pdf"></i> PDF出力</button>
            <button class="btn" id="btnInvoiceXlsx"><i class="fa-regular fa-file-excel"></i> Excel出力</button>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <div class="s muted" style="margin-bottom:6px">未（候補）</div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>選択</th><th>注番</th><th>商品名</th><th>品番</th><th>数量</th>
                  <th>単価</th><th>金額</th><th>出荷日</th>
                </tr>
              </thead>
              <tbody id="tbInvoiceCandidates"></tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:10px">
          <div class="s muted" style="margin-bottom:6px">得意先内 全件（ステータス）</div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>注番</th><th>商品名</th><th>品番</th><th>数量</th><th>単価</th>
                  <th>金額</th><th>出荷日</th><th>状態</th>
                </tr>
              </thead>
              <tbody id="tbInvoiceStatus"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h3 style="margin:0 0 10px">請求書一覧</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr><th>請求書番号</th><th>得意先</th><th>発行日</th><th>合計</th><th>ファイル名</th><th>作成者</th></tr>
            </thead>
            <tbody id="tbInvoiceList"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- ======= DIALOG: 汎用フォーム ======= -->
  <dialog id="dlgForm" class="dlg">
    <h3 id="dlgTitle" style="margin:0 0 10px">フォーム</h3>
    <form id="formBody" method="dialog"></form>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="btnDlgSave">保存</button>
      <button class="btn" id="btnDlgCancel">キャンセル</button>
    </div>
  </dialog>

  <!-- ======= DIALOG: 工程 手入力（OK/NG） ======= -->
  <dialog id="dlgOp" class="dlg">
    <h3 style="margin:0 0 10px">工程 手入力</h3>
    <div class="row"><span class="muted s">注番:</span><b id="opPO"></b></div>
    <div class="form-item">
      <div class="s muted">工程</div>
      <select id="opProcess"></select>
    </div>
    <div class="grid2">
      <div class="form-item">
        <div class="s muted">OK</div>
        <input id="opOK" type="number" min="0" value="0">
      </div>
      <div class="form-item">
        <div class="s muted">NG</div>
        <input id="opNG" type="number" min="0" value="0">
      </div>
    </div>
    <div class="form-item">
      <div class="s muted">備考</div>
      <input id="opNote" placeholder="備考">
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="btnOpSave">保存</button>
      <button class="btn" id="btnOpCancel">キャンセル</button>
    </div>
  </dialog>

  <!-- ======= DIALOG: QR スキャン ======= -->
  <dialog id="dlgScan" class="dlg">
    <h3 style="margin:0 0 8px">QR スキャン</h3>
    <div id="scanResult" class="s muted">—</div>
    <div style="display:grid;gap:6px;margin-top:8px">
      <video id="scanVideo" style="width:100%;max-height:260px;background:#000;border-radius:10px" playsinline></video>
      <canvas id="scanCanvas" style="width:100%;max-height:260px;border:1px solid var(--border);border-radius:10px"></canvas>
      <div class="row">
        <button class="btn primary" id="btnScanStart"><i class="fa-solid fa-camera"></i> スキャン開始</button>
        <button class="btn" id="btnScanClose">閉じる</button>
      </div>
    </div>
  </dialog>

  <!-- ======= Lib eksternal (defer) ======= -->
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <!-- ======= APP ======= -->
  <script defer src="app.js"></script>
</body>
</html>
